/**
 * Created by sam on 9/11/16.
 */

"use strict";


define(['event-emitter'], function (eventEmitter) {


    var addResponse = {
        "player": {
            "publicId": 7,
            "privateId": 85,
            "color": "#ce02ba",
            "name": "7y0kmn1ja2ca8suac3di",
            "initialPositions": [
                {
                    "row": 7,
                    "col": 16,
                    "shapeId": 0
                },
                {
                    "row": 7,
                    "col": 17,
                    "shapeId": 1
                },
                {
                    "row": 8,
                    "col": 17,
                    "shapeId": 2
                },
                {
                    "row": 8,
                    "col": 16,
                    "shapeId": 3
                }
            ]
        },
        "roomState": [
            [
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": 3
                },
                {
                    "shapeId": 1,
                    "playerId": 3
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": 1
                },
                {
                    "shapeId": 1,
                    "playerId": 1
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": 3
                },
                {
                    "shapeId": 2,
                    "playerId": 3
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": 1
                },
                {
                    "shapeId": 2,
                    "playerId": 1
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": 2
                },
                {
                    "shapeId": 1,
                    "playerId": 2
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": 6
                },
                {
                    "shapeId": 1,
                    "playerId": 6
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": 2
                },
                {
                    "shapeId": 2,
                    "playerId": 2
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": 6
                },
                {
                    "shapeId": 2,
                    "playerId": 6
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 0,
                    "playerId": 5
                },
                {
                    "shapeId": 1,
                    "playerId": 5
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": 4
                },
                {
                    "shapeId": 1,
                    "playerId": 4
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": 7
                },
                {
                    "shapeId": 1,
                    "playerId": 7
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 3,
                    "playerId": 5
                },
                {
                    "shapeId": 2,
                    "playerId": 5
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": 4
                },
                {
                    "shapeId": 2,
                    "playerId": 4
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": 7
                },
                {
                    "shapeId": 2,
                    "playerId": 7
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                }
            ],
            [
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 3,
                    "playerId": null
                },
                {
                    "shapeId": 1,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 4,
                    "playerId": null
                },
                {
                    "shapeId": 5,
                    "playerId": null
                },
                {
                    "shapeId": 0,
                    "playerId": null
                },
                {
                    "shapeId": 2,
                    "playerId": null
                }
            ]
        ],
        "players": [
            {
                "publicId": 1,
                "color": "#e8ef56",
                "name": "jf3qas"
            },
            {
                "publicId": 2,
                "color": "#03589e",
                "name": "99rb2b"
            },
            {
                "publicId": 3,
                "color": "#5449aa",
                "name": "g9074a"
            },
            {
                "publicId": 4,
                "color": "#0948e8",
                "name": "8vnpnk"
            },
            {
                "publicId": 5,
                "color": "#36ed79",
                "name": "u1b2z8"
            },
            {
                "publicId": 6,
                "color": "#9e02ff",
                "name": "drxgwx"
            },
            {
                "publicId": 7,
                "color": "#ce02ba",
                "name": "7y0kmn1"
            }
        ],
        "roomId": 623,
        "roomAlias": "test"
    };

    eventEmitter.subscribe('add', function () {

        setTimeout(function () {
            eventEmitter.emit('added', addResponse, true);
            eventEmitter.emit('render-init', addResponse.roomState.map(function (row) {
                return row.map(function (cell) {
                    var player = addResponse.players.filter(function (pl) {
                        return pl.publicId == cell.playerId
                    });
                    return {
                        shapeId: cell.shapeId,
                        color: (Array.isArray(player) && player.length > 0) ? player[0].color : null
                    }
                })
            }), true);
        }, 500);


        setTimeout(function () {
            eventEmitter.emit('render-add', {
                changeColor: [
                    {row: 1, col: 1, color: "#ef4507"},
                    {row: 1, col: 2, color: "#ef4507"},
                    {row: 2, col: 1, color: "#ef4507"},
                    {row: 2, col: 2, color: "#ef4507"},
                ],
                changeShape: [
                    {row: 1, col: 1, shapeId: 0},
                    {row: 1, col: 2, shapeId: 1},
                    {row: 2, col: 1, shapeId: 3},
                    {row: 2, col: 2, shapeId: 2},
                ]
            });


            eventEmitter.emit('added', {
                publicId: 8,
                color: "#ef4507",
                name: "pozni",
                initialPositions: [
                    {
                        row: 1,
                        col: 1,
                        shapeId: 0
                    },
                    {
                        row: 1,
                        col: 2,
                        shapeId: 1
                    },
                    {
                        row: 2,
                        col: 2,
                        shapeId: 2
                    },
                    {
                        row: 2,
                        col: 1,
                        shapeId: 3
                    }
                ]
            })
        }, 1000);
    });


    var turnResponses = {
        "5:7": {
            dontRotate: false,
            rotate: {row: 5, col: 7},
            changeColor: [
                {row: 4, col: 7, color: "#9e02ff"},
                {row: 3, col: 7, color: "#9e02ff"},
                {row: 3, col: 6, color: "#9e02ff"},
                {row: 4, col: 6, color: "#9e02ff"}
            ]
        },
        "5:13": {
            dontRotate: true,
            rotate: {row: 5, col: 13},
            changeColor: [
                {row: 6, col: 13, color: "#03589e"},
                {row: 7, col: 13, color: "#03589e"},
            ]
        },
        "7:13": {
            dontRotate: true,
            rotate: {row: 7, col: 13},
            changeColor: [
                {row: 7, col: 14, color: "#03589e"},
                {row: 7, col: 15, color: "#03589e"},
                {row: 6, col: 15, color: "#03589e"},
                {row: 5, col: 15, color: "#03589e"},
                {row: 4, col: 15, color: "#03589e"}
            ]
        }
    };


    eventEmitter.subscribe('click', function (pos) {
        var key = pos.row + ":" + pos.col;
        if (turnResponses[key] && (key === "7:13" || key === "5:13")) {
            eventEmitter.emit('render-my-rotate', pos);
            emitTurnResponse(turnResponses[key]);
            delete turnResponses[key];
        }
        if (!!turnResponses[key]){
            emitTurnResponse(turnResponses[key]);
            delete turnResponses[key];
        }

    });


    function emitTurnResponse(response) {
        setTimeout(function () {
            eventEmitter.emit('render-turn', response);
        }, 200);
    }

    return {
        connect: function () {

        }
    }

});